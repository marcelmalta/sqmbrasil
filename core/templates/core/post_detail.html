{% extends "base.html" %}
{% load tz %}

{% block title %}{{ post.title }} — SQM Brasil{% endblock %}

{% block content %}
  <article class="max-w-3xl mx-auto">
    <header class="mb-6">
      <h1 class="text-3xl font-bold text-gray-900">{{ post.title }}</h1>
      <div class="mt-2 text-sm text-gray-500">
        Publicado em {{ post.created_at|localtime|date:"d/m/Y H:i" }}
      </div>
    </header>

    {% if post.cover %}
      <img src="{{ post.cover.url }}" alt="{{ post.title }}" class="w-full rounded-xl border mb-6">
    {% endif %}

    {% if post.summary %}
      <p class="text-lg text-gray-700 mb-4">{{ post.summary }}</p>
      <hr class="my-4" />
    {% endif %}

    <div class="prose max-w-none">
      {{ post.content|linebreaks }}
    </div>

    <!-- Curtir e Compartilhar -->
    <div class="mt-6 flex items-center gap-4">
      <form method="post" action="{% url 'like_post' post.id %}">
        {% csrf_token %}
        <button type="submit" class="px-3 py-1 rounded-md border {% if user_liked %}bg-red-500 text-white{% else %}hover:bg-gray-100{% endif %}">
          ❤️ Curtir{% if likes_count %} ({{ likes_count }}){% endif %}
        </button>
      </form>

      <div class="flex gap-2 text-sm">
        <a href="https://wa.me/?text={{ request.build_absolute_uri }}" target="_blank" class="text-green-600">WhatsApp</a>
        <a href="https://twitter.com/intent/tweet?url={{ request.build_absolute_uri }}" target="_blank" class="text-sky-500">Twitter</a>
        <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri }}" target="_blank" class="text-blue-700">Facebook</a>
      </div>
    </div>

    <!-- Comentários -->
    <section class="mt-10">
      <h2 class="text-xl font-semibold mb-4">Comentários ({{ comments_count }})</h2>

      {% if user.is_authenticated %}
        <form method="post" class="mb-6">
          {% csrf_token %}
          <textarea name="comment" rows="3" class="w-full border rounded-md p-2" placeholder="Escreva um comentário..."></textarea>
          <button type="submit" class="mt-2 px-4 py-2 bg-brand text-white rounded-md">Publicar</button>
        </form>
      {% else %}
        <p class="text-gray-600">Faça login para comentar.</p>
      {% endif %}

      {% for c in comments %}
        <div class="mb-4 border-b pb-2">
          <p class="text-sm text-gray-800"><strong>{{ c.user.username }}</strong> disse:</p>
          <p class="text-gray-700">{{ c.content }}</p>
          <span class="text-xs text-gray-500">{{ c.created_at|localtime|date:"d/m/Y H:i" }}</span>

          <!-- Curtir/Responder -->
          <div class="mt-1 flex items-center gap-4 text-sm text-gray-600">
            <form method="post" action="{% url 'like_comment' c.id %}">
              {% csrf_token %}
              <button type="submit" class="hover:text-red-500">
                ❤️ Curtir{% if c.likes.count %} ({{ c.likes.count }}){% endif %}
              </button>
            </form>

            <button type="button" onclick="document.getElementById('reply-{{ c.id }}').classList.toggle('hidden')">
              ↩️ Responder
            </button>
          </div>

          <!-- Form resposta -->
          <div id="reply-{{ c.id }}" class="hidden mt-2">
            <form method="post" action="{% url 'reply_comment' c.id %}">
              {% csrf_token %}
              <textarea name="comment" rows="2" class="w-full border rounded-md p-2" placeholder="Escreva uma resposta..."></textarea>
              <button type="submit" class="mt-1 px-3 py-1 bg-brand text-white rounded-md">Responder</button>
            </form>
          </div>

          <!-- Respostas -->
          {% if c.replies.all %}
            <div class="ml-6 mt-2 space-y-2 border-l pl-3">
              {% for r in c.replies.all %}
                <div>
                  <p class="text-sm"><strong>{{ r.user.username }}</strong> respondeu:</p>
                  <p class="text-gray-700">{{ r.content }}</p>
                  <span class="text-xs text-gray-500">{{ r.created_at|localtime|date:"d/m/Y H:i" }}</span>
                </div>
              {% endfor %}
            </div>
          {% endif %}
        </div>
      {% empty %}
        <p class="text-gray-500">Ainda não há comentários.</p>
      {% endfor %}
    </section>

    <div class="mt-8">
      <a href="/" class="inline-flex items-center text-green-600 hover:underline">&larr; Voltar</a>
    </div>
  </article>
{% endblock %}

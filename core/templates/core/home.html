{% extends "base.html" %}
{% load tz %}

{% block title %}SQM Brasil — Notícias e Comunidade{% endblock %}

{% block content %}
  <!-- HERO -->
  <section class="relative overflow-hidden rounded-2xl border bg-gradient-to-br from-brand/10 via-emerald-50 to-white p-8 mb-10">
    <div class="max-w-3xl">
      <h1 class="text-3xl sm:text-4xl font-extrabold tracking-tight text-gray-900">
        Bem-vindo ao <span class="text-brand">SQM Brasil</span>
      </h1>
      <p class="mt-3 text-gray-700 text-lg">
        Portal de notícias, orientação e comunidade sobre Sensibilidade Química Múltipla.
      </p>
      <div class="mt-6 flex gap-3">
        <a href="/accounts/signup/" class="px-4 py-2 rounded-md bg-brand text-white hover:bg-brand-dark">
          Participar da comunidade
        </a>
        <a href="#feed" class="px-4 py-2 rounded-md border hover:bg-gray-50">
          Ver postagens
        </a>
      </div>
    </div>
    <div class="pointer-events-none absolute -right-10 -top-10 h-48 w-48 rounded-full bg-brand/20 blur-2xl"></div>
  </section>

  <!-- FEED GERAL -->
  <h2 id="feed" class="mb-4 text-xl font-semibold text-gray-800">Postagens</h2>

  {% if combined_posts %}
    <div class="space-y-6">
      {% for item in combined_posts %}
        {% if item.type == "oficial" %}
          <!-- Post oficial -->
          <article class="bg-white rounded-2xl border-2 border-brand shadow-sm p-5">
            {% if item.obj.cover %}
              <a href="{% url 'post_detail' slug=item.obj.slug %}">
                <img src="{{ item.obj.cover.url }}" alt="{{ item.obj.title }}" class="w-full h-52 object-cover rounded-lg mb-3">
              </a>
            {% endif %}
            <h3 class="text-lg font-bold">
              <a href="{% url 'post_detail' slug=item.obj.slug %}" class="hover:text-brand">{{ item.obj.title }}</a>
            </h3>
            {% if item.obj.summary %}
              <p class="mt-2 text-sm text-gray-700">{{ item.obj.summary }}</p>
            {% endif %}
            <div class="mt-3 text-xs text-gray-500 flex items-center gap-3">
              <span>Publicado em {{ item.obj.created_at|localtime|date:"d/m/Y H:i" }}</span>
              <span>❤️ {{ item.obj.likes.count }}</span>
              <span class="ml-auto px-2 py-0.5 text-xs bg-brand/10 text-brand rounded">Oficial</span>
            </div>
          </article>
        {% else %}
          <!-- Post de usuário -->
          <article class="bg-white rounded-2xl border border-gray-200 shadow-sm p-5">
            <div class="flex items-center gap-3 mb-3">
              <div class="h-12 w-12 rounded-full overflow-hidden border">
                {% if item.obj.user.profile.avatar %}
                  <img src="{{ item.obj.user.profile.avatar.url }}" alt="{{ item.obj.user.username }}" class="h-full w-full object-cover">
                {% else %}
                  <div class="h-full w-full flex items-center justify-center bg-gray-100 text-gray-500">?</div>
                {% endif %}
              </div>
              <div>
                <span class="font-semibold">{{ item.obj.user.get_full_name|default:item.obj.user.username }}</span><br>
                <span class="text-xs text-gray-500">Publicado em {{ item.obj.created_at|localtime|date:"d/m/Y H:i" }}</span>
              </div>
            </div>
            <h3 class="text-lg font-semibold mb-2">{{ item.obj.title }}</h3>
            <p class="text-gray-700 mb-3">{{ item.obj.content|linebreaks|truncatewords:50 }}</p>

            {% if item.obj.image %}
              <img src="{{ item.obj.image.url }}" alt="{{ item.obj.title }}" class="rounded-md border mb-3">
            {% endif %}

            {% if item.obj.embed_url %}
              {% if item.obj.is_youtube %}
                <div class="aspect-video mb-3">
                  <iframe class="w-full h-full rounded-md border"
                          src="{{ item.obj.youtube_embed }}"
                          frameborder="0" allowfullscreen></iframe>
                </div>
              {% elif item.obj.is_instagram %}
                <blockquote class="instagram-media" data-instgrm-permalink="{{ item.obj.embed_url }}"></blockquote>
                <script async src="//www.instagram.com/embed.js"></script>
              {% elif item.obj.is_facebook %}
                <div id="fb-root"></div>
                <script async defer crossorigin="anonymous" src="https://connect.facebook.net/pt_BR/sdk.js#xfbml=1&version=v17.0"></script>
                <div class="fb-post" data-href="{{ item.obj.embed_url }}"></div>
              {% else %}
                <a href="{{ item.obj.embed_url }}" target="_blank" class="text-brand underline">Ver vídeo</a>
              {% endif %}
            {% endif %}
          </article>
        {% endif %}
      {% endfor %}
    </div>
  {% else %}
    <div class="bg-white border rounded-xl p-8 text-center text-gray-600 mb-12">
      Ainda não há postagens.
    </div>
  {% endif %}
{% endblock %}
